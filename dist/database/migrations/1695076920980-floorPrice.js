"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.FloorPrice1695076920980 = void 0;
class FloorPrice1695076920980 {
    constructor() {
        this.name = 'FloorPrice1695076920980';
    }
    up(queryRunner) {
        return __awaiter(this, void 0, void 0, function* () {
            yield queryRunner.query(`DELETE FROM "typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ['VIEW', 'orders_view', 'public']);
            yield queryRunner.query(`DROP VIEW "orders_view"`);
            yield queryRunner.query(`DELETE FROM "typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ['VIEW', 'collections_view', 'public']);
            yield queryRunner.query(`DROP VIEW "collections_view"`);
            yield queryRunner.query(`CREATE VIEW "orders_view" AS SELECT "order".*, (SELECT "order"."startTime" <= NOW() AND ("order"."endTime" > NOW() OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales_view" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN (SELECT "balance"."balance" FROM "token_balances_view" "balance" WHERE "balance"."currency" = "order"."currency" AND "balance"."userAddress" = "order"."userAddress") > "order"."price" ELSE (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0 END FROM (SELECT 1 AS dummy_column) "dummy_table") AS "active" FROM "orders" "order"`);
            yield queryRunner.query(`INSERT INTO "typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, [
                'public',
                'VIEW',
                'orders_view',
                'SELECT "order".*, (SELECT "order"."startTime" <= NOW() AND ("order"."endTime" > NOW() OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales_view" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN (SELECT "balance"."balance" FROM "token_balances_view" "balance" WHERE "balance"."currency" = "order"."currency" AND "balance"."userAddress" = "order"."userAddress") > "order"."price" ELSE (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0 END FROM (SELECT 1 AS dummy_column) "dummy_table") AS "active" FROM "orders" "order"',
            ]);
            yield queryRunner.query(`CREATE MATERIALIZED VIEW "collection_rankings" AS SELECT "collection"."address", (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '1 hour'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volume1h", (SELECT COALESCE((SELECT (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '1 hour'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") - SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - (INTERVAL '1 hour' * 2) AND "sale"."timestamp" <= NOW() - INTERVAL '1 hour'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volumeChange1h", (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '6 hours'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volume6h", (SELECT COALESCE((SELECT (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '6 hours'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") - SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - (INTERVAL '6 hours' * 2) AND "sale"."timestamp" <= NOW() - INTERVAL '6 hours'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volumeChange6h", (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '1 day'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volume24h", (SELECT COALESCE((SELECT (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '1 day'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") - SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - (INTERVAL '1 day' * 2) AND "sale"."timestamp" <= NOW() - INTERVAL '1 day'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volumeChange24h", (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '7 days'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volume7d", (SELECT COALESCE((SELECT (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '7 days'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") - SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - (INTERVAL '7 days' * 2) AND "sale"."timestamp" <= NOW() - INTERVAL '7 days'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volumeChange7d", (SELECT COALESCE((SELECT (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '30 days'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") - SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - (INTERVAL '30 days' * 2) AND "sale"."timestamp" <= NOW() - INTERVAL '30 days'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volumeChange30d", (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '30 days'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volume30d", (SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2')) AS "volume", (SELECT MIN(CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "order"."active") AS "floorPrice", (SELECT COALESCE((SELECT MIN(CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "order"."active"), 0) - COALESCE((SELECT MIN(CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM (NOW() - INTERVAL '1 hour') - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "order"."startTime" <= (NOW() - INTERVAL '1 hour') AND ("order"."endTime" > (NOW() - INTERVAL '1 hour') OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "floorChange1h", (SELECT COALESCE((SELECT MIN(CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "order"."active"), 0) - COALESCE((SELECT MIN(CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM (NOW() - INTERVAL '6 hours') - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "order"."startTime" <= (NOW() - INTERVAL '6 hours') AND ("order"."endTime" > (NOW() - INTERVAL '6 hours') OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "floorChange6h", (SELECT COALESCE((SELECT MIN(CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "order"."active"), 0) - COALESCE((SELECT MIN(CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM (NOW() - INTERVAL '1 day') - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "order"."startTime" <= (NOW() - INTERVAL '1 day') AND ("order"."endTime" > (NOW() - INTERVAL '1 day') OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "floorChange24h", (SELECT COALESCE((SELECT MIN(CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "order"."active"), 0) - COALESCE((SELECT MIN(CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM (NOW() - INTERVAL '7 days') - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "order"."startTime" <= (NOW() - INTERVAL '7 days') AND ("order"."endTime" > (NOW() - INTERVAL '7 days') OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "floorChange7d", (SELECT COALESCE((SELECT MIN(CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "order"."active"), 0) - COALESCE((SELECT MIN(CASE WHEN "order"."type" = 'DUTCH_AUCTION' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM (NOW() - INTERVAL '30 days') - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "order"."startTime" <= (NOW() - INTERVAL '30 days') AND ("order"."endTime" > (NOW() - INTERVAL '30 days') OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "floorChange30d" FROM "collections" "collection"`);
            yield queryRunner.query(`INSERT INTO "typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, [
                'public',
                'MATERIALIZED_VIEW',
                'collection_rankings',
                'SELECT "collection"."address", (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'1 hour\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volume1h", (SELECT COALESCE((SELECT (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'1 hour\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") - SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - (INTERVAL \'1 hour\' * 2) AND "sale"."timestamp" <= NOW() - INTERVAL \'1 hour\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volumeChange1h", (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'6 hours\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volume6h", (SELECT COALESCE((SELECT (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'6 hours\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") - SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - (INTERVAL \'6 hours\' * 2) AND "sale"."timestamp" <= NOW() - INTERVAL \'6 hours\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volumeChange6h", (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'1 day\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volume24h", (SELECT COALESCE((SELECT (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'1 day\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") - SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - (INTERVAL \'1 day\' * 2) AND "sale"."timestamp" <= NOW() - INTERVAL \'1 day\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volumeChange24h", (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'7 days\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volume7d", (SELECT COALESCE((SELECT (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'7 days\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") - SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - (INTERVAL \'7 days\' * 2) AND "sale"."timestamp" <= NOW() - INTERVAL \'7 days\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volumeChange7d", (SELECT COALESCE((SELECT (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'30 days\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") - SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - (INTERVAL \'30 days\' * 2) AND "sale"."timestamp" <= NOW() - INTERVAL \'30 days\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volumeChange30d", (SELECT COALESCE((SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'30 days\'), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "volume30d", (SELECT SUM("sale"."price") FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\')) AS "volume", (SELECT MIN(CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "order"."active") AS "floorPrice", (SELECT COALESCE((SELECT MIN(CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "order"."active"), 0) - COALESCE((SELECT MIN(CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM (NOW() - INTERVAL \'1 hour\') - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "order"."startTime" <= (NOW() - INTERVAL \'1 hour\') AND ("order"."endTime" > (NOW() - INTERVAL \'1 hour\') OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "floorChange1h", (SELECT COALESCE((SELECT MIN(CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "order"."active"), 0) - COALESCE((SELECT MIN(CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM (NOW() - INTERVAL \'6 hours\') - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "order"."startTime" <= (NOW() - INTERVAL \'6 hours\') AND ("order"."endTime" > (NOW() - INTERVAL \'6 hours\') OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "floorChange6h", (SELECT COALESCE((SELECT MIN(CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "order"."active"), 0) - COALESCE((SELECT MIN(CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM (NOW() - INTERVAL \'1 day\') - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "order"."startTime" <= (NOW() - INTERVAL \'1 day\') AND ("order"."endTime" > (NOW() - INTERVAL \'1 day\') OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "floorChange24h", (SELECT COALESCE((SELECT MIN(CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "order"."active"), 0) - COALESCE((SELECT MIN(CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM (NOW() - INTERVAL \'7 days\') - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "order"."startTime" <= (NOW() - INTERVAL \'7 days\') AND ("order"."endTime" > (NOW() - INTERVAL \'7 days\') OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "floorChange7d", (SELECT COALESCE((SELECT MIN(CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM NOW() - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "order"."active"), 0) - COALESCE((SELECT MIN(CASE WHEN "order"."type" = \'DUTCH_AUCTION\' THEN "order"."startingPrice" - ("order"."startingPrice" - "order"."price") * EXTRACT(EPOCH FROM (NOW() - INTERVAL \'30 days\') - "order"."startTime") / EXTRACT(EPOCH FROM "order"."endTime" - "order"."startTime") ELSE "order"."price" END) FROM "orders_view" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "order"."startTime" <= (NOW() - INTERVAL \'30 days\') AND ("order"."endTime" > (NOW() - INTERVAL \'30 days\') OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0), 0) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "floorChange30d" FROM "collections" "collection"',
            ]);
            yield queryRunner.query(`CREATE VIEW "collections_view" AS SELECT "collection".*, "ranking"."volume1h", "ranking"."volumeChange1h", "ranking"."volume6h", "ranking"."volumeChange6h", "ranking"."volume24h", "ranking"."volumeChange24h", "ranking"."volume7d", "ranking"."volumeChange7d", "ranking"."volume30d", "ranking"."volumeChange30d", "ranking"."volume", "ranking"."floorChange1h", "ranking"."floorChange6h", "ranking"."floorChange24h", "ranking"."floorChange7d", "ranking"."floorChange30d", "ranking"."floorPrice", (SELECT array_to_json(ARRAY (SELECT json_build_object('collectionAddress', "collection"."address", 'trait', "attribute"."trait", 'values', array_to_json(ARRAY (SELECT json_build_object('collectionAddress', "collection"."address", 'trait', "attribute"."trait", 'value', "value"."value", 'count', COUNT(DISTINCT "value"."tokenId")) FROM "item_attributes" "value" WHERE "value"."collectionAddress" = "collection"."address" AND "value"."trait" = "attribute"."trait" GROUP BY "value"."value"))) FROM "item_attributes" "attribute" WHERE "attribute"."collectionAddress" = "collection"."address" GROUP BY "attribute"."trait")) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "attributes", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '1 hour') AS "saleCount1h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '6 hours') AS "saleCount6h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '1 day') AS "saleCount24h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '7 days') AS "saleCount7d", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '30 days') AS "saleCount30d", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2')) AS "saleCount", (SELECT SUM("balance"."balance") FROM "balances_view" "balance" WHERE "balance"."collectionAddress" = "collection"."address") AS "totalSupply", (SELECT COUNT(DISTINCT "balance"."userAddress") FROM "balances_view" "balance" WHERE "balance"."collectionAddress" = "collection"."address") AS "ownerCount", (SELECT COUNT(DISTINCT "order"."tokenId") FROM "orders_view" "order" WHERE "order"."type" != 'BID' AND "order"."collectionAddress" = "collection"."address" AND "order"."active") AS "listedCount" FROM "collections" "collection" INNER JOIN "collection_rankings" "ranking" ON "ranking"."address" = "collection"."address"`);
            yield queryRunner.query(`INSERT INTO "typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, [
                'public',
                'VIEW',
                'collections_view',
                'SELECT "collection".*, "ranking"."volume1h", "ranking"."volumeChange1h", "ranking"."volume6h", "ranking"."volumeChange6h", "ranking"."volume24h", "ranking"."volumeChange24h", "ranking"."volume7d", "ranking"."volumeChange7d", "ranking"."volume30d", "ranking"."volumeChange30d", "ranking"."volume", "ranking"."floorChange1h", "ranking"."floorChange6h", "ranking"."floorChange24h", "ranking"."floorChange7d", "ranking"."floorChange30d", "ranking"."floorPrice", (SELECT array_to_json(ARRAY (SELECT json_build_object(\'collectionAddress\', "collection"."address", \'trait\', "attribute"."trait", \'values\', array_to_json(ARRAY (SELECT json_build_object(\'collectionAddress\', "collection"."address", \'trait\', "attribute"."trait", \'value\', "value"."value", \'count\', COUNT(DISTINCT "value"."tokenId")) FROM "item_attributes" "value" WHERE "value"."collectionAddress" = "collection"."address" AND "value"."trait" = "attribute"."trait" GROUP BY "value"."value"))) FROM "item_attributes" "attribute" WHERE "attribute"."collectionAddress" = "collection"."address" GROUP BY "attribute"."trait")) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "attributes", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'1 hour\') AS "saleCount1h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'6 hours\') AS "saleCount6h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'1 day\') AS "saleCount24h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'7 days\') AS "saleCount7d", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'30 days\') AS "saleCount30d", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\')) AS "saleCount", (SELECT SUM("balance"."balance") FROM "balances_view" "balance" WHERE "balance"."collectionAddress" = "collection"."address") AS "totalSupply", (SELECT COUNT(DISTINCT "balance"."userAddress") FROM "balances_view" "balance" WHERE "balance"."collectionAddress" = "collection"."address") AS "ownerCount", (SELECT COUNT(DISTINCT "order"."tokenId") FROM "orders_view" "order" WHERE "order"."type" != \'BID\' AND "order"."collectionAddress" = "collection"."address" AND "order"."active") AS "listedCount" FROM "collections" "collection" INNER JOIN "collection_rankings" "ranking" ON "ranking"."address" = "collection"."address"',
            ]);
            yield queryRunner.query(`CREATE INDEX "IDX_3f4a7ccc1a482303f4e2691aa7" ON "collection_rankings" ("floorPrice") `);
            yield queryRunner.query(`CREATE INDEX "IDX_be97d6a4240ed37553f4e48bd8" ON "collection_rankings" ("floorChange30d") `);
            yield queryRunner.query(`CREATE INDEX "IDX_c7710be4c181207608bfb0143d" ON "collection_rankings" ("floorChange7d") `);
            yield queryRunner.query(`CREATE INDEX "IDX_c280af98a12bd7c6ba10d2bcc6" ON "collection_rankings" ("floorChange24h") `);
            yield queryRunner.query(`CREATE INDEX "IDX_6b58d891f22af0ac89180cc114" ON "collection_rankings" ("floorChange6h") `);
            yield queryRunner.query(`CREATE INDEX "IDX_06734c07e43ff351ebf493e33b" ON "collection_rankings" ("floorChange1h") `);
            yield queryRunner.query(`CREATE INDEX "IDX_b17a67a70e2f03413900e26f2a" ON "collection_rankings" ("volume") `);
            yield queryRunner.query(`CREATE INDEX "IDX_08ee63f23bde3eab0afb567b56" ON "collection_rankings" ("volumeChange30d") `);
            yield queryRunner.query(`CREATE INDEX "IDX_e8fb42993a0d4eb84ef95a5b20" ON "collection_rankings" ("volume30d") `);
            yield queryRunner.query(`CREATE INDEX "IDX_4f3bd77a95b96e9963daaf1706" ON "collection_rankings" ("volumeChange7d") `);
            yield queryRunner.query(`CREATE INDEX "IDX_ccd587b71f134cf49a39a98121" ON "collection_rankings" ("volume7d") `);
            yield queryRunner.query(`CREATE INDEX "IDX_3b15dc53cfd47a86e736e31376" ON "collection_rankings" ("volumeChange24h") `);
            yield queryRunner.query(`CREATE INDEX "IDX_c3826858600dd573e343f384b1" ON "collection_rankings" ("volume24h") `);
            yield queryRunner.query(`CREATE INDEX "IDX_00d7569f150c0af06ba3b23fed" ON "collection_rankings" ("volumeChange6h") `);
            yield queryRunner.query(`CREATE INDEX "IDX_fa037a61922e387470daf27f57" ON "collection_rankings" ("volume6h") `);
            yield queryRunner.query(`CREATE INDEX "IDX_29b62298489f0c7aa98b4f560f" ON "collection_rankings" ("volumeChange1h") `);
            yield queryRunner.query(`CREATE INDEX "IDX_a55f3312d42ad5ed8e8118aaa5" ON "collection_rankings" ("volume1h") `);
        });
    }
    down(queryRunner) {
        return __awaiter(this, void 0, void 0, function* () {
            yield queryRunner.query(`DROP INDEX "public"."IDX_a55f3312d42ad5ed8e8118aaa5"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_29b62298489f0c7aa98b4f560f"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_fa037a61922e387470daf27f57"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_00d7569f150c0af06ba3b23fed"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_c3826858600dd573e343f384b1"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_3b15dc53cfd47a86e736e31376"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_ccd587b71f134cf49a39a98121"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_4f3bd77a95b96e9963daaf1706"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_e8fb42993a0d4eb84ef95a5b20"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_08ee63f23bde3eab0afb567b56"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_b17a67a70e2f03413900e26f2a"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_06734c07e43ff351ebf493e33b"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_6b58d891f22af0ac89180cc114"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_c280af98a12bd7c6ba10d2bcc6"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_c7710be4c181207608bfb0143d"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_be97d6a4240ed37553f4e48bd8"`);
            yield queryRunner.query(`DROP INDEX "public"."IDX_3f4a7ccc1a482303f4e2691aa7"`);
            yield queryRunner.query(`DELETE FROM "typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ['VIEW', 'collections_view', 'public']);
            yield queryRunner.query(`DROP VIEW "collections_view"`);
            yield queryRunner.query(`DELETE FROM "typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ['MATERIALIZED_VIEW', 'collection_rankings', 'public']);
            yield queryRunner.query(`DROP MATERIALIZED VIEW "collection_rankings"`);
            yield queryRunner.query(`DELETE FROM "typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ['VIEW', 'orders_view', 'public']);
            yield queryRunner.query(`DROP VIEW "orders_view"`);
            yield queryRunner.query(`CREATE VIEW "collections_view" AS SELECT "collection".*, "volume"."volume1h", "volume"."volumeChange1h", "volume"."volume6h", "volume"."volumeChange6h", "volume"."volume24h", "volume"."volumeChange24h", "volume"."volume7d", "volume"."volumeChange7d", "volume"."volume30d", "volume"."volumeChange30d", "volume"."volume", (SELECT array_to_json(ARRAY (SELECT json_build_object('collectionAddress', "collection"."address", 'trait', "attribute"."trait", 'values', array_to_json(ARRAY (SELECT json_build_object('collectionAddress', "collection"."address", 'trait', "attribute"."trait", 'value', "value"."value", 'count', COUNT(DISTINCT "value"."tokenId")) FROM "item_attributes" "value" WHERE "value"."collectionAddress" = "collection"."address" AND "value"."trait" = "attribute"."trait" GROUP BY "value"."value"))) FROM "item_attributes" "attribute" WHERE "attribute"."collectionAddress" = "collection"."address" GROUP BY "attribute"."trait")) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "attributes", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '1 hour') AS "saleCount1h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '6 hours') AS "saleCount6h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '1 day') AS "saleCount24h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '7 days') AS "saleCount7d", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND "sale"."timestamp" > NOW() - INTERVAL '30 days') AS "saleCount30d", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2')) AS "saleCount", (SELECT SUM("balance"."balance") FROM "balances_view" "balance" WHERE "balance"."collectionAddress" = "collection"."address") AS "totalSupply", (SELECT COUNT(DISTINCT "balance"."userAddress") FROM "balances_view" "balance" WHERE "balance"."collectionAddress" = "collection"."address") AS "ownerCount", (SELECT COUNT(DISTINCT "order"."tokenId") FROM "orders" "order" WHERE "order"."type" IN ('ASK', 'DUTCH_AUCTION', 'ENGLISH_AUCTION') AND "order"."collectionAddress" = "collection"."address" AND "order"."startTime" <= NOW() AND ("order"."endTime" > NOW() OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN ('0000000000000000000000000000000000000000', 'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0) AS "listedCount" FROM "collections" "collection" INNER JOIN "collection_volumes" "volume" ON "volume"."address" = "collection"."address"`);
            yield queryRunner.query(`INSERT INTO "typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, [
                'public',
                'VIEW',
                'collections_view',
                'SELECT "collection".*, "volume"."volume1h", "volume"."volumeChange1h", "volume"."volume6h", "volume"."volumeChange6h", "volume"."volume24h", "volume"."volumeChange24h", "volume"."volume7d", "volume"."volumeChange7d", "volume"."volume30d", "volume"."volumeChange30d", "volume"."volume", (SELECT array_to_json(ARRAY (SELECT json_build_object(\'collectionAddress\', "collection"."address", \'trait\', "attribute"."trait", \'values\', array_to_json(ARRAY (SELECT json_build_object(\'collectionAddress\', "collection"."address", \'trait\', "attribute"."trait", \'value\', "value"."value", \'count\', COUNT(DISTINCT "value"."tokenId")) FROM "item_attributes" "value" WHERE "value"."collectionAddress" = "collection"."address" AND "value"."trait" = "attribute"."trait" GROUP BY "value"."value"))) FROM "item_attributes" "attribute" WHERE "attribute"."collectionAddress" = "collection"."address" GROUP BY "attribute"."trait")) FROM (SELECT 1 AS dummy_column) "dummy_table") AS "attributes", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'1 hour\') AS "saleCount1h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'6 hours\') AS "saleCount6h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'1 day\') AS "saleCount24h", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'7 days\') AS "saleCount7d", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND "sale"."timestamp" > NOW() - INTERVAL \'30 days\') AS "saleCount30d", (SELECT COUNT(*) FROM "sales" "sale" WHERE "sale"."collectionAddress" = "collection"."address" AND "sale"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\')) AS "saleCount", (SELECT SUM("balance"."balance") FROM "balances_view" "balance" WHERE "balance"."collectionAddress" = "collection"."address") AS "totalSupply", (SELECT COUNT(DISTINCT "balance"."userAddress") FROM "balances_view" "balance" WHERE "balance"."collectionAddress" = "collection"."address") AS "ownerCount", (SELECT COUNT(DISTINCT "order"."tokenId") FROM "orders" "order" WHERE "order"."type" IN (\'ASK\', \'DUTCH_AUCTION\', \'ENGLISH_AUCTION\') AND "order"."collectionAddress" = "collection"."address" AND "order"."startTime" <= NOW() AND ("order"."endTime" > NOW() OR "order"."endTime" IS NULL) AND "order"."cancelTimestamp" IS NULL AND NOT EXISTS (SELECT * FROM "sales" "sale" WHERE "sale"."orderHash" = "order"."hash") AND "order"."currency" IN (\'0000000000000000000000000000000000000000\', \'c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\') AND (SELECT "balance"."balance" FROM "balances_view" "balance" WHERE "balance"."userAddress" = "order"."userAddress" AND "balance"."collectionAddress" = "order"."collectionAddress" AND "balance"."tokenId" = "order"."tokenId") > 0) AS "listedCount" FROM "collections" "collection" INNER JOIN "collection_volumes" "volume" ON "volume"."address" = "collection"."address"',
            ]);
            yield queryRunner.query(`CREATE VIEW "orders_view" AS SELECT "order".* FROM "orders" "order"`);
            yield queryRunner.query(`INSERT INTO "typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, [
                'public',
                'VIEW',
                'orders_view',
                'SELECT "order".* FROM "orders" "order"',
            ]);
        });
    }
}
exports.FloorPrice1695076920980 = FloorPrice1695076920980;
//# sourceMappingURL=1695076920980-floorPrice.js.map